<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#8B7BA0">
  <title>Muster-Maschine â€“ Kidsneed</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --s-1:8px;--s-2:16px;--s-3:24px;--s-4:32px;
      --radius-sm:12px;--radius-md:16px;--radius-lg:24px;--radius-xl:28px;
      --shadow-soft:0 2px 10px rgba(45,42,38,.10);--shadow-subtle:0 1px 3px rgba(45,42,38,.06);
      --bg-canvas:#F5F0E8;--bg-card:#FFFFFF;--bg-muted:#EDE8DC;
      --ink-primary:#2D2A26;--ink-secondary:#6B665C;--ink-light:#9C9588;
      --accent:#8B7BA0;--accent-light:rgba(139,123,160,.12);--accent-dark:#6B5B80;
      --color-success:#7BA08A;--color-success-bg:rgba(123,160,138,.15);
      --color-error:#C4726C;--color-error-bg:rgba(196,114,108,.15);
      --color-warn:#D4A574;--color-warn-bg:rgba(212,165,116,.15);
      --text-2xl:24px;--text-xl:20px;--text-lg:18px;--text-md:16px;--text-sm:14px;--text-xs:12px;
      --motion-fast:150ms;--motion-base:260ms;--ease-out:cubic-bezier(0.33,1,0.68,1);
      --app-max-w:560px;--font:'Nunito',system-ui,sans-serif;
    }
    *,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;background:var(--bg-canvas);color:var(--ink-primary);font-family:var(--font);font-weight:600;font-size:var(--text-md);line-height:1.5;display:flex;align-items:center;justify-content:center;overflow:hidden}
    *:focus-visible{outline:3px solid var(--accent);outline-offset:2px;border-radius:var(--radius-sm)}
    @media(prefers-reduced-motion:reduce){*{transition-duration:0.01ms!important;animation-duration:0.01ms!important}}
    
    .app-frame{width:100%;height:100%;background:var(--bg-card);display:flex;flex-direction:column;overflow:hidden;position:relative}
    @media(min-width:520px){body{padding:var(--s-3)}.app-frame{max-width:var(--app-max-w);height:94dvh;max-height:920px;border:3px solid var(--ink-primary);border-radius:var(--radius-lg);box-shadow:var(--shadow-subtle)}}
    
    header{height:72px;padding:0 var(--s-3);display:flex;align-items:center;justify-content:space-between;gap:var(--s-2);border-bottom:3px solid var(--ink-primary);background:var(--bg-card);flex:0 0 auto}
    .brand{display:flex;flex-direction:column;gap:2px}.brand-title{font-size:var(--text-xl);font-weight:900;letter-spacing:-0.02em;line-height:1.1;display:flex;align-items:center;gap:var(--s-1)}.brand-subtitle{font-size:var(--text-xs);font-weight:900;text-transform:uppercase;letter-spacing:.10em;color:var(--ink-secondary)}
    .header-stats{display:flex;gap:var(--s-1);align-items:center}
    .pill{min-height:48px;padding:10px 12px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-muted);display:flex;align-items:center;gap:6px;cursor:pointer;transition:transform var(--motion-fast) var(--ease-out)}.pill:hover{box-shadow:var(--shadow-soft);transform:translateY(-1px)}.pill:active{transform:scale(0.98)}.pill .icon{font-size:16px}.pill .val{font-weight:900;font-size:var(--text-sm);font-variant-numeric:tabular-nums}
    
    .viewport{flex:1;overflow-y:auto;padding:var(--s-3);background:radial-gradient(1200px 340px at 50% 0%,rgba(139,123,160,.08),transparent 60%),var(--bg-card);overscroll-behavior:contain}
    
    .card{border:3px solid var(--ink-primary);border-radius:var(--radius-lg);background:var(--bg-card);box-shadow:var(--shadow-subtle);margin-bottom:var(--s-3)}.card-section{padding:var(--s-3)}.card-section+.card-section{border-top:3px solid var(--ink-primary)}
    .section-label{font-size:var(--text-xs);font-weight:900;text-transform:uppercase;letter-spacing:.10em;color:var(--ink-secondary);margin-bottom:var(--s-2)}
    
    .grade-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--s-1)}.grade-btn{min-height:52px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-muted);font-family:var(--font);font-weight:900;font-size:var(--text-lg);color:var(--ink-primary);cursor:pointer;transition:transform var(--motion-fast) var(--ease-out)}.grade-btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-soft)}.grade-btn:active{transform:scale(0.98)}.grade-btn.selected{background:var(--accent);color:white;border-color:var(--accent-dark)}
    
    .mode-tabs{display:flex;gap:var(--s-1);margin-bottom:var(--s-2)}.mode-tab{flex:1;min-height:44px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-muted);font-family:var(--font);font-weight:900;font-size:var(--text-sm);color:var(--ink-secondary);cursor:pointer;transition:all var(--motion-fast)}.mode-tab:hover{background:var(--accent-light)}.mode-tab.active{background:var(--accent);color:white;border-color:var(--accent-dark)}
    
    .task-area{background:var(--bg-muted);border:3px solid var(--ink-primary);border-radius:var(--radius-md);padding:var(--s-3);min-height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:var(--s-2)}
    .task-label{font-size:var(--text-xs);font-weight:900;text-transform:uppercase;letter-spacing:.10em;color:var(--accent)}
    .task-hint{font-size:var(--text-sm);font-weight:800;color:var(--ink-secondary);text-align:center}
    
    .pattern-display{display:flex;flex-direction:column;gap:var(--s-2);align-items:center;width:100%}
    .pattern-row{display:flex;gap:var(--s-1);align-items:center;justify-content:center;flex-wrap:wrap}
    .pattern-cell{width:48px;height:48px;border:3px solid var(--ink-primary);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:900;background:var(--bg-card);transition:all var(--motion-fast)}
    .pattern-cell.large{width:56px;height:56px;font-size:28px}
    .pattern-cell.small{width:40px;height:40px;font-size:20px}
    .pattern-cell.question{background:var(--accent-light);border-color:var(--accent);color:var(--accent);animation:pulse 1.5s ease-in-out infinite}
    .pattern-cell.highlight{background:var(--color-warn-bg);border-color:var(--color-warn)}
    .pattern-cell.correct-reveal{background:var(--color-success);border-color:var(--color-success);color:white}
    
    .matrix-container{display:flex;flex-direction:column;gap:var(--s-2);align-items:center}
    .matrix-grid{display:grid;gap:4px;background:var(--ink-primary);border:3px solid var(--ink-primary);border-radius:var(--radius-sm);padding:4px}
    .matrix-cell{width:44px;height:44px;background:var(--bg-card);display:flex;align-items:center;justify-content:center;font-size:22px;border-radius:6px}
    .matrix-cell.question{background:var(--accent-light);color:var(--accent);font-size:28px}
    
    .sequence-builder{display:flex;flex-direction:column;gap:var(--s-2);width:100%}
    .sequence-track{display:flex;gap:6px;padding:var(--s-2);background:var(--bg-card);border:2px solid var(--ink-primary);border-radius:var(--radius-sm);min-height:64px;flex-wrap:wrap;justify-content:center}
    .sequence-slot{width:44px;height:44px;border:2px dashed var(--ink-light);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:20px;background:var(--bg-muted)}
    .sequence-slot.filled{border-style:solid;border-color:var(--ink-primary);background:var(--bg-card)}
    .sequence-slot.current{border-color:var(--accent);border-width:3px;background:var(--accent-light)}
    
    .palette{display:flex;gap:var(--s-1);flex-wrap:wrap;justify-content:center;padding:var(--s-2);background:var(--bg-card);border:2px solid var(--ink-primary);border-radius:var(--radius-sm)}
    .palette-item{width:48px;height:48px;border:3px solid var(--ink-primary);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:22px;background:var(--bg-muted);cursor:pointer;transition:all var(--motion-fast)}
    .palette-item:hover{transform:scale(1.1);box-shadow:var(--shadow-soft)}
    .palette-item:active{transform:scale(0.95)}
    .palette-item.selected{border-color:var(--accent);background:var(--accent-light)}
    
    .answers{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--s-2);margin-top:var(--s-3)}
    .answer-btn{padding:var(--s-2);border:3px solid var(--ink-primary);border-radius:var(--radius-md);background:var(--bg-card);font-family:var(--font);font-size:var(--text-lg);font-weight:900;color:var(--ink-primary);cursor:pointer;transition:all var(--motion-fast);min-height:64px;display:flex;align-items:center;justify-content:center;gap:var(--s-1)}
    .answer-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-soft);background:var(--accent-light)}
    .answer-btn:active{transform:scale(0.98)}
    .answer-btn.correct{background:var(--color-success);border-color:var(--color-success);color:white}
    .answer-btn.incorrect{background:var(--color-error);border-color:var(--color-error);color:white}
    .answer-btn:disabled{cursor:not-allowed;opacity:.7}
    
    .feedback{margin-top:var(--s-3);padding:var(--s-2);border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-muted);font-weight:800;font-size:var(--text-sm);color:var(--ink-secondary);display:flex;align-items:flex-start;gap:10px}
    .feedback .ficon{font-size:18px;flex-shrink:0}
    .feedback.success{background:var(--color-success-bg);border-color:var(--color-success);color:#2D5A3A}
    .feedback.error{background:var(--color-error-bg);border-color:var(--color-error);color:#6B3A32}
    
    .history-dots{display:flex;gap:6px;margin-top:var(--s-2);justify-content:center;flex-wrap:wrap}
    .dot{width:24px;height:24px;border-radius:50%;border:2px solid var(--ink-primary);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900}
    .dot.correct{background:var(--color-success-bg);border-color:var(--color-success);color:var(--color-success)}
    .dot.incorrect{background:var(--color-error-bg);border-color:var(--color-error);color:var(--color-error)}
    
    .btn{min-height:52px;padding:14px 18px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-card);color:var(--ink-secondary);font-family:var(--font);font-weight:900;font-size:var(--text-md);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:all var(--motion-fast);text-decoration:none}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-soft)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);color:white;border-color:var(--accent-dark)}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn:disabled{opacity:.4;cursor:not-allowed}
    .actions{display:flex;gap:var(--s-2);margin-top:var(--s-3)}.actions .btn{flex:1}
    
    footer{flex:0 0 auto;padding:var(--s-2) var(--s-3);padding-bottom:max(var(--s-2),env(safe-area-inset-bottom));background:var(--bg-card);border-top:3px solid var(--ink-primary);display:flex;gap:var(--s-2)}
    footer .btn{flex:1}
    
    .overlay{position:absolute;inset:0;background:rgba(0,0,0,.26);display:none;align-items:flex-end;justify-content:center;padding:var(--s-3);z-index:100}.overlay.open{display:flex}
    .sheet{width:100%;max-width:560px;max-height:85vh;overflow-y:auto;border:3px solid var(--ink-primary);border-radius:var(--radius-xl);background:var(--bg-card);box-shadow:var(--shadow-soft);padding:var(--s-3);animation:slideUp var(--motion-base) var(--ease-out)}
    .sheet h2{margin:0 0 var(--s-1);font-size:var(--text-xl);font-weight:900;text-align:center}
    .sheet>p{margin:0 0 var(--s-3);color:var(--ink-secondary);font-weight:800;font-size:var(--text-sm);text-align:center}
    .sheet-actions{display:flex;gap:var(--s-2);margin-top:var(--s-3)}.sheet-actions .btn{flex:1}
    
    .explain-box{background:var(--bg-muted);border:2px solid var(--ink-primary);border-radius:var(--radius-md);padding:var(--s-3)}
    .explain-title{font-weight:900;font-size:var(--text-sm);color:var(--accent);margin-bottom:var(--s-2);display:flex;align-items:center;gap:var(--s-1)}
    .explain-content{font-size:var(--text-sm);line-height:1.6}
    .explain-result{background:var(--accent);color:white;padding:var(--s-2);border-radius:var(--radius-md);text-align:center;font-weight:900;font-size:var(--text-lg);margin-top:var(--s-2)}
    
    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--s-2);margin-bottom:var(--s-3)}
    .stat-card{background:var(--bg-muted);border:2px solid var(--ink-primary);border-radius:var(--radius-md);padding:var(--s-2);text-align:center}
    .stat-card-value{font-size:var(--text-2xl);font-weight:900;color:var(--accent);font-variant-numeric:tabular-nums}
    .stat-card-label{font-size:var(--text-xs);font-weight:900;text-transform:uppercase;letter-spacing:.08em;color:var(--ink-secondary);margin-top:4px}
    
    .settings-group{background:var(--bg-muted);border:2px solid var(--ink-primary);border-radius:var(--radius-md);overflow:hidden}
    .setting-row{display:flex;justify-content:space-between;align-items:center;padding:var(--s-2);min-height:56px}
    .setting-row+.setting-row{border-top:2px solid var(--ink-primary)}
    .setting-label{font-weight:900;font-size:var(--text-sm);color:var(--ink-primary)}
    .toggle{width:52px;height:32px;background:var(--bg-canvas);border:2px solid var(--ink-primary);border-radius:16px;position:relative;cursor:pointer}
    .toggle::after{content:'';position:absolute;width:24px;height:24px;background:var(--bg-card);border:2px solid var(--ink-primary);border-radius:12px;top:2px;left:2px;transition:left var(--motion-fast)}
    .toggle.on{background:var(--color-success);border-color:var(--color-success)}
    .toggle.on::after{left:22px;border-color:var(--color-success)}
    
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
    @keyframes pop{0%{transform:scale(0.8);opacity:0}50%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
    
    .pop-in{animation:pop 0.3s var(--ease-out)}
    
    @media(max-width:400px){
      header{padding:0 var(--s-2)}.viewport{padding:var(--s-2)}footer{padding:var(--s-2)}
      .brand-title{font-size:var(--text-lg)}.pill{padding:8px 10px;min-height:44px}
      .grade-btn{min-height:48px;font-size:var(--text-md)}
      .pattern-cell{width:40px;height:40px;font-size:20px}
      .pattern-cell.large{width:48px;height:48px;font-size:24px}
      .matrix-cell{width:36px;height:36px;font-size:18px}
      .answer-btn{font-size:var(--text-md);min-height:56px}
      .btn{min-height:48px;font-size:var(--text-sm)}
    }
  </style>
</head>
<body>
  <div class="app-frame">
    <header>
      <div class="brand">
        <div class="brand-title">â–¦ Muster-Maschine</div>
        <div class="brand-subtitle">Kidsneed Logik</div>
      </div>
      <div class="header-stats">
        <div class="pill" id="stats-pill" role="button" tabindex="0" aria-label="Statistiken">
          <span class="icon">âœ“</span>
          <span class="val" id="score">0</span>/<span class="val" id="total">0</span>
        </div>
        <div class="pill" aria-label="Serie">
          <span class="icon">ğŸ”¥</span>
          <span class="val" id="streak">0</span>
        </div>
      </div>
    </header>
    
    <main class="viewport">
      <div class="card">
        <section class="card-section">
          <div class="section-label">Klassenstufe</div>
          <div class="grade-grid" id="grades">
            <button class="grade-btn" data-g="1" type="button">1</button>
            <button class="grade-btn selected" data-g="2" type="button">2</button>
            <button class="grade-btn" data-g="3" type="button">3</button>
            <button class="grade-btn" data-g="4" type="button">4</button>
          </div>
          
          <div class="section-label" style="margin-top:var(--s-3)">Muster-Typ</div>
          <div class="mode-tabs" id="mode-tabs">
            <button class="mode-tab active" data-mode="sequence" type="button">Reihen</button>
            <button class="mode-tab" data-mode="matrix" type="button">Matrix</button>
            <button class="mode-tab" data-mode="growing" type="button">Wachsend</button>
          </div>
        </section>
        
        <section class="card-section">
          <div class="task-area" id="task-area">
            <div class="task-label" id="task-label">Muster erkennen</div>
            <div class="task-hint" id="task-hint">WÃ¤hle eine Klasse und starte!</div>
            <div class="pattern-display" id="pattern-display"></div>
          </div>
          
          <div class="answers" id="answers"></div>
          
          <div class="feedback" id="feedback">
            <span class="ficon">ğŸ¯</span>
            <span>Erkenne das Muster und finde das fehlende Element!</span>
          </div>
          
          <div class="history-dots" id="history-dots"></div>
        </section>
        
        <section class="card-section">
          <div class="actions">
            <button class="btn" id="help-btn" type="button" disabled>ğŸ’¡ Tipp</button>
            <button class="btn primary" id="start-btn" type="button">Neues Muster</button>
          </div>
        </section>
      </div>
    </main>
    
    <footer>
      <a class="btn" href="https://humaneed.github.io/kidsneed/" aria-label="ZurÃ¼ck zum Hub">â† Hub</a>
      <button class="btn" id="settings-btn" type="button">âš™ï¸</button>
      <button class="btn" id="stats-btn" type="button">ğŸ“Š</button>
    </footer>
    
    <!-- Help Modal -->
    <div class="overlay" id="modal-help">
      <div class="sheet">
        <h2>ğŸ’¡ Tipp</h2>
        <div id="help-content"></div>
        <div class="sheet-actions">
          <button class="btn primary" id="ok-help" type="button">Verstanden</button>
        </div>
      </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="overlay" id="modal-settings">
      <div class="sheet">
        <h2>âš™ï¸ Einstellungen</h2>
        <p>Passe dein Ãœbungserlebnis an.</p>
        <div class="settings-group">
          <div class="setting-row">
            <span class="setting-label">TÃ¶ne</span>
            <div class="toggle on" id="toggle-sound" role="switch" aria-checked="true" tabindex="0"></div>
          </div>
          <div class="setting-row">
            <span class="setting-label">TastaturkÃ¼rzel</span>
            <div class="toggle on" id="toggle-keyboard" role="switch" aria-checked="true" tabindex="0"></div>
          </div>
        </div>
        <div class="sheet-actions">
          <button class="btn" id="reset-stats" type="button">ğŸ—‘ï¸ Reset</button>
          <button class="btn primary" id="ok-settings" type="button">Fertig</button>
        </div>
      </div>
    </div>
    
    <!-- Stats Modal -->
    <div class="overlay" id="modal-stats">
      <div class="sheet">
        <h2>ğŸ“Š Statistiken</h2>
        <div id="stats-content"></div>
        <div class="sheet-actions">
          <button class="btn primary" id="ok-stats" type="button">SchlieÃŸen</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function() {
  'use strict';
  
  const $ = id => document.getElementById(id);
  
  const Utils = {
    rnd: (a, b) => Math.floor(Math.random() * (b - a + 1)) + a,
    pick: arr => arr[Math.floor(Math.random() * arr.length)],
    pickN: (arr, n) => Utils.shuffle(arr).slice(0, n),
    shuffle: arr => arr.slice().sort(() => Math.random() - 0.5),
    range: (start, end) => Array.from({length: end - start + 1}, (_, i) => start + i)
  };
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const state = {
    grade: 2,
    mode: 'sequence',
    score: 0,
    total: 0,
    streak: 0,
    maxStreak: 0,
    currentTask: null,
    answered: false,
    history: [],
    settings: { sound: true, keyboard: true }
  };
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AUDIO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  
  const playBeep = (freq, dur, type = 'sine') => {
    if (!state.settings.sound) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.type = type;
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
  };
  
  const playCorrect = () => { playBeep(523, 0.12); setTimeout(() => playBeep(659, 0.15), 100); };
  const playIncorrect = () => playBeep(294, 0.2, 'triangle');
  const playClick = () => playBeep(440, 0.05);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STORAGE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const saveState = () => {
    try {
      localStorage.setItem('kidsneed_muster', JSON.stringify({
        score: state.score,
        total: state.total,
        streak: state.streak,
        maxStreak: state.maxStreak,
        history: state.history.slice(-30),
        settings: state.settings,
        grade: state.grade
      }));
    } catch {}
  };
  
  const loadState = () => {
    try {
      const s = JSON.parse(localStorage.getItem('kidsneed_muster'));
      if (s) {
        Object.assign(state, {
          score: s.score || 0,
          total: s.total || 0,
          streak: s.streak || 0,
          maxStreak: s.maxStreak || 0,
          history: s.history || [],
          grade: s.grade || 2
        });
        state.settings = { ...state.settings, ...s.settings };
        document.querySelectorAll('.grade-btn').forEach(b => 
          b.classList.toggle('selected', +b.dataset.g === state.grade)
        );
        $('toggle-sound').classList.toggle('on', state.settings.sound);
        $('toggle-keyboard').classList.toggle('on', state.settings.keyboard);
      }
    } catch {}
  };
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PATTERN DATABASE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const SHAPES = ['â—', 'â– ', 'â–²', 'â—†', 'â˜…', 'â™¥', 'â—‹', 'â–¡', 'â–³', 'â—‡'];
  const COLORS_EMOJI = ['ğŸ”´', 'ğŸ”µ', 'ğŸŸ¢', 'ğŸŸ¡', 'ğŸŸ£', 'ğŸŸ ', 'âšª', 'ğŸŸ¤'];
  const ANIMALS = ['ğŸ•', 'ğŸˆ', 'ğŸ', 'ğŸ¦', 'ğŸŸ', 'ğŸ´', 'ğŸ„', 'ğŸ·', 'ğŸ”', 'ğŸ¦†', 'ğŸ°', 'ğŸ»'];
  const FRUITS = ['ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸ‡', 'ğŸ“', 'ğŸŒ', 'ğŸ‘', 'ğŸ’', 'ğŸ¥'];
  const WEATHER = ['â˜€ï¸', 'ğŸŒ§ï¸', 'â„ï¸', 'ğŸŒˆ', 'â›ˆï¸', 'ğŸŒ¤ï¸', 'â˜ï¸', 'ğŸ’¨'];
  const NUMBERS = ['1', '2', '3', '4', '5', '6', '7', '8', '9'];
  const LETTERS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
  
  const ALL_SYMBOLS = [...SHAPES, ...COLORS_EMOJI, ...ANIMALS.slice(0, 6), ...FRUITS.slice(0, 6)];
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PATTERN GENERATORS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const PatternGen = {
    
    // SEQUENCE PATTERNS (Reihen)
    sequence(grade) {
      const types = grade <= 2 
        ? ['ab', 'abc', 'aab', 'number']
        : ['ab', 'abc', 'aab', 'abba', 'number', 'growing'];
      
      const type = Utils.pick(types);
      let pattern, sequence, answer, rule, hint;
      
      switch(type) {
        case 'ab': {
          const symbols = Utils.pickN(grade <= 2 ? COLORS_EMOJI : ALL_SYMBOLS, 2);
          pattern = [symbols[0], symbols[1]];
          const repeats = grade <= 2 ? 2 : 3;
          sequence = [];
          for (let i = 0; i < repeats; i++) sequence.push(...pattern);
          answer = pattern[sequence.length % pattern.length];
          rule = 'AB-Muster';
          hint = `Das Muster ${pattern[0]} ${pattern[1]} wiederholt sich.`;
          break;
        }
        
        case 'abc': {
          const symbols = Utils.pickN(grade <= 2 ? SHAPES.slice(0, 5) : ALL_SYMBOLS, 3);
          pattern = symbols;
          sequence = [...pattern, ...pattern].slice(0, 5);
          answer = pattern[sequence.length % pattern.length];
          rule = 'ABC-Muster';
          hint = `Das Muster ${pattern.join(' ')} wiederholt sich.`;
          break;
        }
        
        case 'aab': {
          const symbols = Utils.pickN(COLORS_EMOJI, 2);
          pattern = [symbols[0], symbols[0], symbols[1]];
          sequence = [...pattern, ...pattern].slice(0, 5);
          answer = pattern[sequence.length % pattern.length];
          rule = 'AAB-Muster';
          hint = `Das Muster ${pattern.join(' ')} wiederholt sich.`;
          break;
        }
        
        case 'abba': {
          const symbols = Utils.pickN(SHAPES, 2);
          pattern = [symbols[0], symbols[1], symbols[1], symbols[0]];
          sequence = [...pattern, pattern[0]];
          answer = pattern[1];
          rule = 'ABBA-Muster (Spiegelung)';
          hint = `Das Muster ${pattern.join(' ')} ist gespiegelt.`;
          break;
        }
        
        case 'number': {
          const start = Utils.rnd(1, grade <= 2 ? 3 : 5);
          const step = Utils.rnd(1, grade <= 2 ? 2 : 4);
          sequence = Utils.range(0, 4).map(i => start + i * step);
          answer = start + 5 * step;
          pattern = sequence;
          rule = `+${step} Muster`;
          hint = `Jede Zahl ist um ${step} grÃ¶ÃŸer als die vorherige.`;
          break;
        }
        
        case 'growing': {
          const options = [
            { seq: [1, 2, 4, 8], ans: 16, rule: 'Ã—2 (Verdoppeln)', hint: 'Jede Zahl wird verdoppelt.' },
            { seq: [1, 3, 6, 10], ans: 15, rule: '+2, +3, +4, +5', hint: 'Der Abstand wÃ¤chst um 1.' },
            { seq: [2, 4, 6, 8], ans: 10, rule: '+2 (gerade Zahlen)', hint: 'Es sind die geraden Zahlen.' },
            { seq: [1, 4, 9, 16], ans: 25, rule: 'Quadratzahlen', hint: '1Â², 2Â², 3Â², 4Â², 5Â²...' }
          ];
          const opt = Utils.pick(options.slice(0, grade - 1 || 1));
          sequence = opt.seq;
          answer = opt.ans;
          pattern = sequence;
          rule = opt.rule;
          hint = opt.hint;
          break;
        }
      }
      
      // Generate wrong answers
      const wrong = [];
      if (typeof answer === 'number') {
        wrong.push(answer + Utils.rnd(1, 3), answer - Utils.rnd(1, 2), answer + Utils.rnd(4, 7));
      } else {
        const pool = pattern.length > 0 ? ALL_SYMBOLS.filter(s => !pattern.includes(s)) : ALL_SYMBOLS;
        wrong.push(...Utils.pickN(pool, 3));
      }
      
      return {
        type: 'sequence',
        sequence: [...sequence, '?'],
        answer: String(answer),
        options: Utils.shuffle([String(answer), ...wrong.filter(w => w !== answer && w > 0).slice(0, 3).map(String)]),
        rule,
        hint,
        explain: `<b>Regel:</b> ${rule}<br><b>Tipp:</b> ${hint}<br>Die Reihe geht weiter mit <b>${answer}</b>.`
      };
    },
    
    // MATRIX PATTERNS
    matrix(grade) {
      const size = grade <= 2 ? 2 : 3;
      const symbols = Utils.pickN(grade <= 2 ? SHAPES.slice(0, 4) : SHAPES, size);
      
      // Create grid where each row and column has each symbol once
      const grid = [];
      for (let r = 0; r < size; r++) {
        const row = [];
        for (let c = 0; c < size; c++) {
          row.push(symbols[(r + c) % size]);
        }
        grid.push(row);
      }
      
      // Pick random cell to hide
      const hideR = Utils.rnd(0, size - 1);
      const hideC = Utils.rnd(0, size - 1);
      const answer = grid[hideR][hideC];
      grid[hideR][hideC] = '?';
      
      // Wrong answers
      const wrong = symbols.filter(s => s !== answer);
      if (wrong.length < 3) {
        wrong.push(...Utils.pickN(SHAPES.filter(s => !symbols.includes(s)), 3 - wrong.length));
      }
      
      return {
        type: 'matrix',
        grid,
        size,
        answer,
        options: Utils.shuffle([answer, ...wrong.slice(0, 3)]),
        rule: 'Jede Zeile und Spalte enthÃ¤lt jedes Symbol einmal.',
        hint: 'Schau dir an, welches Symbol in der Zeile und Spalte fehlt.',
        explain: `Jede Zeile und Spalte enthÃ¤lt jedes Symbol genau einmal.<br>Das fehlende Symbol ist <b>${answer}</b>.`
      };
    },
    
    // GROWING PATTERNS (Visual)
    growing(grade) {
      const patterns = [
        {
          name: 'Treppe',
          stages: [['â– '], ['â– ', 'â– â– '], ['â– ', 'â– â– ', 'â– â– â– ']],
          next: ['â– ', 'â– â– ', 'â– â– â– ', 'â– â– â– â– '],
          answer: '4',
          question: 'Wie viele BlÃ¶cke hat die nÃ¤chste Stufe?',
          options: ['3', '4', '5', '6'],
          hint: 'Die Stufen wachsen: 1, 2, 3, ...',
          explain: 'Jede Stufe hat einen Block mehr. Die nÃ¤chste hat 4 BlÃ¶cke.'
        },
        {
          name: 'Quadrat',
          stages: [['â—'], ['â—â—', 'â—â—'], ['â—â—â—', 'â—â—â—', 'â—â—â—']],
          next: ['â—â—â—â—', 'â—â—â—â—', 'â—â—â—â—', 'â—â—â—â—'],
          answer: '16',
          question: 'Wie viele Punkte hat das nÃ¤chste Quadrat?',
          options: ['12', '14', '16', '18'],
          hint: 'Die Quadrate sind: 1Ã—1, 2Ã—2, 3Ã—3, ...',
          explain: '1Ã—1=1, 2Ã—2=4, 3Ã—3=9, 4Ã—4=<b>16</b>'
        },
        {
          name: 'Dreieck',
          stages: [['â–²'], ['â–²', 'â–²â–²'], ['â–²', 'â–²â–²', 'â–²â–²â–²']],
          next: ['â–²', 'â–²â–²', 'â–²â–²â–²', 'â–²â–²â–²â–²'],
          answer: '10',
          question: 'Wie viele Dreiecke insgesamt im nÃ¤chsten Muster?',
          options: ['8', '9', '10', '12'],
          hint: '1, 3, 6, ... (Dreieckszahlen)',
          explain: '1, 1+2=3, 1+2+3=6, 1+2+3+4=<b>10</b>'
        }
      ];
      
      const p = Utils.pick(patterns.slice(0, grade));
      
      return {
        type: 'growing',
        pattern: p,
        answer: p.answer,
        options: Utils.shuffle(p.options),
        rule: p.name + '-Muster',
        hint: p.hint,
        question: p.question,
        explain: p.explain
      };
    }
  };
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDERING
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const renderPattern = (task) => {
    const display = $('pattern-display');
    
    if (task.type === 'sequence') {
      display.innerHTML = `
        <div class="pattern-row">
          ${task.sequence.map((item, i) => `
            <div class="pattern-cell ${item === '?' ? 'question' : ''} pop-in" style="animation-delay:${i * 0.1}s">
              ${item}
            </div>
          `).join('')}
        </div>
      `;
    }
    
    else if (task.type === 'matrix') {
      display.innerHTML = `
        <div class="matrix-container">
          <div class="matrix-grid" style="grid-template-columns: repeat(${task.size}, 1fr)">
            ${task.grid.flat().map((cell, i) => `
              <div class="matrix-cell ${cell === '?' ? 'question' : ''} pop-in" style="animation-delay:${i * 0.05}s">
                ${cell}
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    else if (task.type === 'growing') {
      const p = task.pattern;
      display.innerHTML = `
        <div class="pattern-row" style="gap: var(--s-3); align-items: flex-end;">
          ${p.stages.map((stage, si) => `
            <div class="pop-in" style="animation-delay:${si * 0.15}s; display:flex; flex-direction:column; align-items:center;">
              ${stage.map(row => `<div style="font-size:14px; letter-spacing:2px;">${row}</div>`).join('')}
              <div style="font-size:var(--text-xs); color:var(--ink-secondary); margin-top:4px;">${si + 1}</div>
            </div>
          `).join('')}
          <div class="pattern-cell question large pop-in" style="animation-delay:0.5s">?</div>
        </div>
        <div class="task-hint" style="margin-top:var(--s-2)">${p.question}</div>
      `;
    }
  };
  
  const renderAnswers = (task) => {
    $('answers').innerHTML = task.options.map(opt => `
      <button class="answer-btn" data-v="${opt}" type="button">
        ${task.type === 'sequence' && isNaN(opt) ? `<span style="font-size:28px">${opt}</span>` : opt}
      </button>
    `).join('');
  };
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UI UPDATES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const updateStats = () => {
    $('score').textContent = state.score;
    $('total').textContent = state.total;
    $('streak').textContent = state.streak;
  };
  
  const updateHistoryDots = () => {
    $('history-dots').innerHTML = state.history.slice(-10).map(h => 
      `<div class="dot ${h.correct ? 'correct' : 'incorrect'}">${h.correct ? 'âœ“' : 'âœ—'}</div>`
    ).join('');
  };
  
  const showFeedback = (text, type = '') => {
    const fb = $('feedback');
    fb.className = 'feedback' + (type ? ' ' + type : '');
    fb.innerHTML = `<span class="ficon">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'ğŸ¯'}</span><span>${text}</span>`;
  };
  
  const openModal = id => $(id).classList.add('open');
  const closeModal = id => $(id).classList.remove('open');
  
  const showStatsModal = () => {
    const acc = state.total > 0 ? Math.round((state.score / state.total) * 100) : 0;
    $('stats-content').innerHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-card-value">${state.total}</div>
          <div class="stat-card-label">Aufgaben</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-value">${state.score}</div>
          <div class="stat-card-label">Richtig</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-value">${acc}%</div>
          <div class="stat-card-label">Genauigkeit</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-value">${state.maxStreak}</div>
          <div class="stat-card-label">Beste Serie</div>
        </div>
      </div>
    `;
    openModal('modal-stats');
  };
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GAME LOGIC
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const newTask = () => {
    playClick();
    
    let task;
    switch(state.mode) {
      case 'sequence':
        task = PatternGen.sequence(state.grade);
        break;
      case 'matrix':
        task = PatternGen.matrix(state.grade);
        break;
      case 'growing':
        task = PatternGen.growing(state.grade);
        break;
      default:
        task = PatternGen.sequence(state.grade);
    }
    
    state.currentTask = task;
    state.answered = false;
    
    $('task-label').textContent = task.rule || 'Muster erkennen';
    $('task-hint').textContent = '';
    $('help-btn').disabled = false;
    
    renderPattern(task);
    renderAnswers(task);
    showFeedback('Erkenne das Muster und wÃ¤hle das fehlende Element!');
  };
  
  const handleAnswer = (btn, val) => {
    if (state.answered) return;
    state.answered = true;
    state.total++;
    
    const correct = String(val) === String(state.currentTask.answer);
    
    if (correct) {
      state.score++;
      state.streak++;
      if (state.streak > state.maxStreak) state.maxStreak = state.streak;
      btn.classList.add('correct');
      showFeedback('ğŸ‰ Richtig! Super gemacht!', 'success');
      playCorrect();
      
      // Reveal answer in pattern
      document.querySelectorAll('.pattern-cell.question, .matrix-cell.question').forEach(el => {
        el.classList.remove('question');
        el.classList.add('correct-reveal');
        el.textContent = state.currentTask.answer;
      });
    } else {
      state.streak = 0;
      btn.classList.add('incorrect');
      document.querySelectorAll('.answer-btn').forEach(b => {
        if (String(b.dataset.v) === String(state.currentTask.answer)) {
          b.classList.add('correct');
        }
      });
      showFeedback(`Fast! Die Antwort ist: ${state.currentTask.answer}`, 'error');
      playIncorrect();
    }
    
    document.querySelectorAll('.answer-btn').forEach(b => b.disabled = true);
    state.history.push({ correct });
    updateStats();
    updateHistoryDots();
    saveState();
  };
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EVENT LISTENERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Grade selection
  $('grades').onclick = e => {
    const btn = e.target.closest('.grade-btn');
    if (!btn) return;
    state.grade = +btn.dataset.g;
    document.querySelectorAll('.grade-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    saveState();
  };
  
  // Mode selection
  $('mode-tabs').onclick = e => {
    const btn = e.target.closest('.mode-tab');
    if (!btn) return;
    state.mode = btn.dataset.mode;
    document.querySelectorAll('.mode-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  };
  
  // Main buttons
  $('start-btn').onclick = newTask;
  
  $('help-btn').onclick = () => {
    if (!state.currentTask) return;
    $('help-content').innerHTML = `
      <div class="explain-box">
        <div class="explain-title">ğŸ’¡ Tipp</div>
        <div class="explain-content">${state.currentTask.hint || state.currentTask.explain}</div>
      </div>
    `;
    openModal('modal-help');
  };
  
  $('stats-btn').onclick = showStatsModal;
  $('stats-pill').onclick = showStatsModal;
  $('settings-btn').onclick = () => openModal('modal-settings');
  
  // Settings toggles
  $('toggle-sound').onclick = () => {
    state.settings.sound = !state.settings.sound;
    $('toggle-sound').classList.toggle('on');
    saveState();
  };
  
  $('toggle-keyboard').onclick = () => {
    state.settings.keyboard = !state.settings.keyboard;
    $('toggle-keyboard').classList.toggle('on');
    saveState();
  };
  
  $('reset-stats').onclick = () => {
    if (!confirm('Wirklich alle Statistiken zurÃ¼cksetzen?')) return;
    state.score = 0;
    state.total = 0;
    state.streak = 0;
    state.maxStreak = 0;
    state.history = [];
    updateStats();
    updateHistoryDots();
    saveState();
    closeModal('modal-settings');
  };
  
  // Modal close handlers
  ['help', 'settings', 'stats'].forEach(name => {
    const okBtn = $(`ok-${name}`);
    if (okBtn) okBtn.onclick = () => closeModal(`modal-${name}`);
    $(`modal-${name}`).onclick = e => {
      if (e.target === $(`modal-${name}`)) closeModal(`modal-${name}`);
    };
  });
  
  // Answer clicks
  $('answers').onclick = e => {
    const btn = e.target.closest('.answer-btn');
    if (btn && !btn.disabled) handleAnswer(btn, btn.dataset.v);
  };
  
  // Keyboard shortcuts
  document.onkeydown = e => {
    if (!state.settings.keyboard) return;
    
    if (e.key === 'Escape') {
      ['help', 'settings', 'stats'].forEach(n => closeModal(`modal-${n}`));
      return;
    }
    
    if (document.querySelector('.overlay.open')) return;
    
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      $('start-btn').click();
    } else if ('1234'.includes(e.key)) {
      const btn = document.querySelectorAll('.answer-btn')[+e.key - 1];
      if (btn && !btn.disabled) btn.click();
    } else if (e.key.toLowerCase() === 'h') {
      $('help-btn').click();
    }
  };
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  loadState();
  updateStats();
  updateHistoryDots();
  
  console.log('âœ… Muster-Maschine geladen.');
})();
</script>
</body>
</html>
